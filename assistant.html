<!DOCTYPE html>
<html lang="ru">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00eaff">

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jarvis 3.0 Ultra</title>
<style>
  :root{
    --accent:#00eaff;
    --bg:#000;
    --dim:#051016;
    --danger:#ff3b3b;
    --text:#aef7ff;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#000 0%, #041018 60%);color:var(--text);font-family:Inter, Arial, sans-serif}
  .wrap{max-width:1000px;margin:20px auto;padding:20px}
  header{display:flex;align-items:center;gap:20px}
  h1{margin:0;font-weight:600;letter-spacing:1px;text-shadow:0 0 16px rgba(0,234,255,0.08)}
  #reactor{width:220px;height:220px;border-radius:50%;margin:18px auto;position:relative;display:grid;place-items:center}
  .ring{position:absolute;border-radius:50%;box-shadow:0 0 30px var(--accent);border:2px solid rgba(0,234,255,0.06)}
  .ring.r1{width:100%;height:100%;animation:spin 20s linear infinite}
  .ring.r2{width:140%;height:140%;transform:translate(-10%,-10%);animation:spin 30s linear reverse infinite;opacity:.5}
  .core{width:60%;height:60%;border-radius:50%;background:radial-gradient(ellipse,#00303b 0%, #001617 100%);display:grid;place-items:center;box-shadow:0 0 40px rgba(0,234,255,0.12) inset}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  button{padding:12px 18px;border-radius:10px;border:none;background:var(--accent);color:#001;font-weight:700;cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  #status{padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.25);box-shadow:inset 0 0 8px rgba(0,0,0,0.6)}
  #log{height:160px;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;margin-top:12px;font-size:14px;}
  .controls{display:flex;gap:10px;align-items:center}
  .mode{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
  .mode.active{background:linear-gradient(90deg,var(--accent),#59d2ff);color:#001;font-weight:700}
  .small{font-size:13px;opacity:.9}
  .chip{padding:6px 8px;border-radius:8px;background:#021417;border:1px solid rgba(0,234,255,0.06)}
  footer{margin-top:18px;font-size:13px;color:rgba(174,247,255,0.7)}
  .scanline{height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);margin-top:10px;border-radius:2px;opacity:0;}
  .visual-beep{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent);opacity:0;transition:0.12s}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>JARVIS 3.0 Ultra</h1>
      <div class="small">–ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ ‚Äî –Ω–∞–∂–º–∏ <b>–ó–∞–ø—É—Å—Ç–∏—Ç—å</b> 1 —Ä–∞–∑, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ.</div>
    </div>
    <div style="margin-left:auto">
      <div id="status" class="chip">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ</div>
    </div>
  </header>

  <div id="reactor">
    <div class="ring r2"></div>
    <div class="ring r1"></div>
    <div class="core">
      <div id="core-text">OFF</div>
    </div>
  </div>

  <div class="row">
    <div class="controls">
      <button id="startBtn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Jarvis</button>
      <button id="stopBtn" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <div class="chip">–†–µ–∂–∏–º: <span id="modeLabel">–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</span></div>
      <div class="chip">–ì–æ–ª–æ—Å: <span id="voiceLabel">–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span></div>
      <div style="display:flex;align-items:center;gap:8px;margin-left:8px">
        <div class="visual-beep" id="vbeep"></div>
      </div>
    </div>
  </div>

  <div style="display:flex;gap:16px;margin-top:12px;flex-wrap:wrap">
    <div style="flex:1;min-width:320px">
      <div class="row" style="gap:8px;margin-bottom:8px">
        <div class="mode" data-mode="normal">–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</div>
        <div class="mode" data-mode="combat">–ë–æ–µ–≤–æ–π</div>
        <div class="mode" data-mode="silent">–¢–∏—Ö–∏–π</div>
        <div class="mode" data-mode="night">–ù–æ—á–Ω–æ–π</div>
      </div>

      <div id="log" aria-live="polite"></div>
    </div>

    <div style="width:320px">
      <div style="background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.2));padding:12px;border-radius:10px">
        <div class="small" style="margin-bottom:8px">–ö–æ–º–∞–Ω–¥—ã (–ø—Ä–∏–º–µ—Ä):</div>
        <ul class="small">
          <li>"–î–∂–∞—Ä–≤–∏—Å" ‚Äî –ø—Ä–∏–≤–ª–µ—á—å –≤–Ω–∏–º–∞–Ω–∏–µ</li>
          <li>"–≤–∫–ª—é—á–∏ –º—É–∑—ã–∫—É" ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª music.mp3</li>
          <li>"–æ—Ç–∫—Ä–æ–π —é—Ç—É–±/–≥—É–≥–ª/–∏–Ω—Å—Ç–∞–≥—Ä–∞–º/—Ç–∏–∫ —Ç–æ–∫/–≤–∫–æ–Ω—Ç–∞–∫—Ç–µ"</li>
          <li>"–Ω–∞–π–¥–∏ {–∑–∞–ø—Ä–æ—Å}" ‚Äî –ø–æ–∏—Å–∫ –≤ Google</li>
          <li>"–∫–∞–∫–æ–µ –≤—Ä–µ–º—è" / "–∫–∞–∫–∞—è –¥–∞—Ç–∞"</li>
          <li>"—Å–∫–∞–∂–∏ —à—É—Ç–∫—É" / "—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"</li>
          <li>"–∑–∞–ø–æ–º–Ω–∏ –∫–æ–º–∞–Ω–¥—É {—Ñ—Ä–∞–∑–∞} => {–¥–µ–π—Å—Ç–≤–∏–µ}"</li>
          <li>"—Ä–µ–∂–∏–º –±–æ–µ–≤–æ–π/–Ω–æ—á–Ω–æ–π/—Ç–∏—Ö–∏–π/–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π"</li>
          <li>"—ç—Ñ—Ñ–µ–∫—Ç —Ä–æ–±–æ—Ç" / "—ç—Ñ—Ñ–µ–∫—Ç –æ–±—ã—á–Ω—ã–π"</li>
        </ul>
      </div>

      <div style="margin-top:10px;padding:10px;background:#001216;border-radius:10px">
        <div class="small">PWA (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</div>
        <div class="small">–ß—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: –æ—Ç–∫—Ä–æ–π –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ ‚Üí ¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ¬ª –∏–ª–∏ "Add to Desktop". –í PWA Jarvis –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</div>
      </div>
    </div>
  </div>

  <div class="scanline" id="scanline"></div>

  <footer>–°–æ–∑–¥–∞–Ω–æ –ª–µ–≥–∞–ª—å–Ω–æ ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –∫–ª–∏–∫–∞ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è. –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è Jarvis –º–æ–∂–µ—Ç —Å–ª—É—à–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ.</footer>
</div>

<script>
  // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è service worker (PWA) ‚Äî –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(reg => console.log('SW registered', reg))
    .catch(err => console.log('SW registration failed', err));
}

/* Jarvis 3.0 Ultra ‚Äî single-file. –°–æ—Ö—Ä–∞–Ω–∏ –∫–∞–∫ assistant.html –∏ –ø–æ–ª–æ–∂–∏ music.mp3 —Ä—è–¥–æ–º. */
(async function(){
  // DOM
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const statusEl = document.getElementById('status');
  const coreText = document.getElementById('core-text');
  const logEl    = document.getElementById('log');
  const modesEls = document.querySelectorAll('.mode');
  const modeLabel= document.getElementById('modeLabel');
  const voiceLabel= document.getElementById('voiceLabel');
  const vbeep = document.getElementById('vbeep');
  const scanline = document.getElementById('scanline');

  // state
  let recognition = null;
  let listening = false;
  let mode = 'normal'; // normal, combat, silent, night
  let robotEffect = false;
  let voices = [];
  let chosenVoice = null;
  let memoryCommands = {}; // user saved commands

  // init voices
  function loadVoices(){
    voices = speechSynthesis.getVoices();
    // try find a russian voice
    chosenVoice = voices.find(v => v.lang && v.lang.startsWith('ru')) || voices[0] || null;
    voiceLabel.innerText = chosenVoice ? (chosenVoice.name + ' ('+chosenVoice.lang+')') : '–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é';
  }
  loadVoices();
  if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;

  function log(msg){
    let time = new Date().toLocaleTimeString();
    logEl.innerHTML = `<div class="small">[${time}] ${escapeHtml(msg)}</div>` + logEl.innerHTML;
  }
  function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // visual helpers
  function setStatus(text, color){
    statusEl.innerText = '–°—Ç–∞—Ç—É—Å: ' + text;
    if(color) statusEl.style.boxShadow = `0 0 10px ${color}`;
    else statusEl.style.boxShadow = '';
  }
  function pulseBeep(){
    vbeep.style.opacity = 1;
    setTimeout(()=> vbeep.style.opacity = 0, 120);
  }
  function setCore(text){
    coreText.innerText = text;
  }
  function showScan(duration=1200){
    scanline.style.opacity = 1;
    scanline.style.transition = `opacity ${duration/1000}s linear`;
    setTimeout(()=> scanline.style.opacity = 0, duration);
  }

  // speech output with optional robot-like effect (limited by browser API)
  function speak(text, opts = {}){
    const rateMap = {normal:1, combat:1.1, silent:0.95, night:0.9};
    const pitchMap = {normal:1, combat:1.05, silent:0.95, night:0.9};
    const rate = opts.rate || rateMap[mode] || 1;
    const pitch = opts.pitch || pitchMap[mode] || 1;
    if(robotEffect){
      // Robot effect fallback: use short repeated syllables and lower pitch to imitate metallic voice.
      // True timbre manipulation is limited in browsers ‚Äî we can only tweak pitch/rate and choose voice.
      let u = new SpeechSynthesisUtterance(text);
      u.rate = rate * 0.95;
      u.pitch = pitch * 0.6;
      if(chosenVoice) u.voice = chosenVoice;
      // small stutter for 'robot' flavor
      u.onstart = () => pulseBeep();
      speechSynthesis.speak(u);
      return;
    }
    // normal speak
    let u = new SpeechSynthesisUtterance(text);
    u.rate = rate;
    u.pitch = pitch;
    if(chosenVoice) u.voice = chosenVoice;
    u.onstart = () => pulseBeep();
    speechSynthesis.speak(u);
  }

  // Mode UI
  modesEls.forEach(el => {
    el.addEventListener('click', () => {
      modesEls.forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      mode = el.dataset.mode;
      modeLabel.innerText = (el.innerText || '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π');
      applyModeVisuals();
      log('–†–µ–∂–∏–º: '+mode);
      speak('–†–µ–∂–∏–º ' + (el.innerText || '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π') + ' –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.');
    });
  });
  // default active
  document.querySelector('.mode[data-mode="normal"]').classList.add('active');

  function applyModeVisuals(){
    const root = document.documentElement;
    if(mode === 'combat'){
      root.style.setProperty('--accent','#ff6b6b');
      document.body.style.background = 'linear-gradient(180deg,#100000,#0a0606)';
      setCore('COMBAT');
    } else if(mode === 'silent'){
      root.style.setProperty('--accent','#7dd3fc');
      document.body.style.background = 'linear-gradient(180deg,#001018,#001316)';
      setCore('SILENT');
    } else if(mode === 'night'){
      root.style.setProperty('--accent','#6b7cff');
      document.body.style.background = 'linear-gradient(180deg,#02021a,#001122)';
      setCore('NIGHT');
    } else {
      root.style.setProperty('--accent','#00eaff');
      document.body.style.background = 'linear-gradient(180deg,#000,#041018)';
      setCore('ON');
    }
  }
  applyModeVisuals();

  // Commands handling
  function handleCommand(cmdRaw){
    const cmd = cmdRaw.toLowerCase().trim();
    log('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ' + cmd);
    showScan(800);
    // if user saved a command triggers
    for(const key of Object.keys(memoryCommands)){
      if(cmd.includes(key)){
        let action = memoryCommands[key];
        log(`–í—ã–ø–æ–ª–Ω—è—é –∑–∞–ø–æ–º–Ω–µ–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É: ${key} -> ${action}`);
        executeAction(action);
        return;
      }
    }

    // Built-in commands
    if(cmd.includes('–¥–∂–∞—Ä–≤–∏—Å')){
      speak('–°–ª—É—à–∞—é, –±—Ä–∞—Ç.');
      return;
    }
    if(cmd.includes('–ø—Ä–∏–≤–µ—Ç')){
      speak('–ü—Ä–∏–≤–µ—Ç, –±—Ä–∞—Ç! –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.');
      return;
    }
    if(/–≤—Ä–µ–º—è|–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å/.test(cmd)){
      let t = new Date().toLocaleTimeString();
      speak('–°–µ–π—á–∞—Å ' + t);
      return;
    }
    if(/–¥–∞—Ç–∞|–∫–∞–∫–∞—è –¥–∞—Ç–∞/.test(cmd)){
      let d = new Date().toLocaleDateString();
      speak('–°–µ–≥–æ–¥–Ω—è ' + d);
      return;
    }
    if(cmd.includes('—Å–∫–∞–∂–∏ —à—É—Ç–∫—É') || cmd.includes('—à—É—Ç–∫')){
      speak('–ü–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –Ω–µ –±–æ—è—Ç—Å—è —Ç–µ–º–Ω–æ—Ç—ã? –ü–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∏—Ö –µ—Å—Ç—å —Å–≤–µ—Ç–ª–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ‚Äî –¥–µ–±–∞–≥–≥–µ—Ä.');
      return;
    }
    if(cmd.includes('–≤–∫–ª—é—á–∏ –º—É–∑—ã–∫—É') || cmd.includes('–ø–æ—Å—Ç–∞–≤—å –º—É–∑—ã–∫—É') || cmd.includes('–º—É–∑—ã–∫—É')){
      speak('–í–∫–ª—é—á–∞—é –º—É–∑—ã–∫—É.');
      try{
        executeAction({type:'audio', src:'music.mp3'});
      }catch(e){ log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É: ' + e); speak('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –º—É–∑—ã–∫—É.'); }
      return;
    }
    if(cmd.startsWith('–Ω–∞–π–¥–∏ ')){
      let q = cmd.replace('–Ω–∞–π–¥–∏ ', '').trim();
      if(q){
        speak('–ò—â—É ' + q);
        window.open('https://www.google.com/search?q=' + encodeURIComponent(q), '_blank');
      } else speak('–ß—Ç–æ –∏—Å–∫–∞—Ç—å?');
      return;
    }
    if(cmd.includes('–æ—Ç–∫—Ä–æ–π youtube') || cmd.includes('–æ—Ç–∫—Ä–æ–π —é—Ç—É–±') || cmd.includes('—é—Ç—É–±')){
      speak('–û—Ç–∫—Ä—ã–≤–∞—é YouTube');
      window.open('https://youtube.com', '_blank');
      return;
    }
    if(cmd.includes('–æ—Ç–∫—Ä–æ–π –≥—É–≥–ª') || cmd.includes('–æ—Ç–∫—Ä–æ–π google') || cmd.includes('–≥—É–≥–ª')){
      speak('–û—Ç–∫—Ä—ã–≤–∞—é Google');
      window.open('https://google.com', '_blank');
      return;
    }
    if(cmd.includes('–∏–Ω—Å—Ç–∞–≥—Ä–∞–º') || cmd.includes('instagram')){
      speak('–û—Ç–∫—Ä—ã–≤–∞—é Instagram');
      window.open('https://instagram.com', '_blank');
      return;
    }
    if(cmd.includes('—Ç–∏–∫ —Ç–æ–∫') || cmd.includes('tiktok')){
      speak('–û—Ç–∫—Ä—ã–≤–∞—é TikTok');
      window.open('https://tiktok.com', '_blank');
      return;
    }
    if(cmd.includes('–≤–∫–æ–Ω—Ç–∞–∫—Ç–µ') || cmd.includes('–≤–∫')){
      speak('–û—Ç–∫—Ä—ã–≤–∞—é –í–ö–æ–Ω—Ç–∞–∫—Ç–µ');
      window.open('https://vk.com', '_blank');
      return;
    }
    if(cmd.includes('—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ') || cmd.includes('—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ')){
      speak('–ó–∞–ø—É—Å–∫–∞—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.');
      startScanAnimation();
      setTimeout(()=>{ speak('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ê–Ω–æ–º–∞–ª–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.'); }, 1800);
      return;
    }
    if(cmd.startsWith('—Ä–µ–∂–∏–º ')){
      let r = cmd.replace('—Ä–µ–∂–∏–º ','').trim();
      const map = { '–±–æ–µ–≤–æ–π':'combat', '–±–æ–µ–≤–æ–π —Ä–µ–∂–∏–º':'combat', '—Ç–∏—Ö–∏–π':'silent', '–Ω–æ—á–Ω–æ–π':'night', '–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π':'normal' };
      if(map[r]){
        document.querySelector(`.mode[data-mode="${map[r]}"]`).click();
      } else {
        speak('–ù–µ –∑–Ω–∞—é —Ç–∞–∫–æ–π —Ä–µ–∂–∏–º.');
      }
      return;
    }
    if(cmd.includes('—ç—Ñ—Ñ–µ–∫—Ç —Ä–æ–±–æ—Ç') || cmd.includes('—Ä–æ–±–æ—Ç –≥–æ–ª–æ—Å') || cmd.includes('–≥–æ–ª–æ—Å —Ä–æ–±–æ—Ç')){
      robotEffect = true;
      speak('–†–æ–±–æ—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –≤–∫–ª—é—á—ë–Ω.');
      return;
    }
    if(cmd.includes('—ç—Ñ—Ñ–µ–∫—Ç –æ–±—ã—á–Ω—ã–π') || cmd.includes('—É–±–µ—Ä–∏ —Ä–æ–±–æ—Ç')){
      robotEffect = false;
      speak('–û–±—ã—á–Ω—ã–π –≥–æ–ª–æ—Å –≤–∫–ª—é—á—ë–Ω.');
      return;
    }
    if(cmd.startsWith('–∑–∞–ø–æ–º–Ω–∏ –∫–æ–º–∞–Ω–¥—É ')){
      // —Ñ–æ—Ä–º–∞—Ç: "–∑–∞–ø–æ–º–Ω–∏ –∫–æ–º–∞–Ω–¥—É {—Ñ—Ä–∞–∑–∞} => {–¥–µ–π—Å—Ç–≤–∏–µ}" –∏–ª–∏ "–∑–∞–ø–æ–º–Ω–∏ –∫–æ–º–∞–Ω–¥—É {—Ñ—Ä–∞–∑–∞} —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å {–¥–µ–π—Å—Ç–≤–∏–µ}"
      let rest = cmd.replace('–∑–∞–ø–æ–º–Ω–∏ –∫–æ–º–∞–Ω–¥—É ','').trim();
      let parts = rest.split('=>');
      if(parts.length<2) {
        speak('–§–æ—Ä–º–∞—Ç: –∑–∞–ø–æ–º–Ω–∏ –∫–æ–º–∞–Ω–¥—É –§–†–ê–ó–ê => –î–ï–ô–°–¢–í–ò–ï');
        return;
      }
      let phrase = parts[0].trim();
      let action = parts.slice(1).join('=>').trim();
      memoryCommands[phrase] = { type:'open', url: action.startsWith('http')? action : action }; // store raw, executor will try open or audio
      speak('–ó–∞–ø–æ–º–Ω–∏–ª –∫–æ–º–∞–Ω–¥—É: ' + phrase);
      log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: "'+phrase+'" => "'+action+'"');
      return;
    }

    // fallback
    speak('–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª –∫–æ–º–∞–Ω–¥—É. –ü–æ–≤—Ç–æ—Ä–∏, –±—Ä–∞—Ç.');
  }

  // Execute high-level action objects
  function executeAction(action){
    if(!action) return;
    if(action.type === 'audio'){
      let a = new Audio(action.src);
      a.play().catch(e => log('–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ: ' + e));
      return;
    }
    if(action.type === 'open'){
      if(action.url && action.url.startsWith('http')) window.open(action.url,'_blank');
      else window.open('https://www.google.com/search?q=' + encodeURIComponent(action.url),'_blank');
      return;
    }
    // if plain string try open as url or search
    if(typeof action === 'string'){
      if(action.endsWith('.mp3')) {
        let a = new Audio(action);
        a.play().catch(e => log('–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ: ' + e));
      } else if(action.startsWith('http')) window.open(action,'_blank');
      else window.open('https://www.google.com/search?q=' + encodeURIComponent(action),'_blank');
    }
  }

  // scan animation
  function startScanAnimation(){
    setStatus('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', 'var(--accent)');
    showScan(900);
    pulseBeep();
    // visual core spin speed change
    document.querySelector('.ring.r1').style.animationDuration = '6s';
    setTimeout(()=>{ document.querySelector('.ring.r1').style.animationDuration = '20s'; setStatus('–ê–∫—Ç–∏–≤–µ–Ω'); }, 1400);
  }

  // create and start recognition
  function createRecognition(){
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if(!window.SpeechRecognition){
      log('–û—à–∏–±–∫–∞: SpeechRecognition API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.');
      speak('–≠—Ç–æ—Ç –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π Chrome –∏–ª–∏ Edge.');
      return null;
    }
    const rec = new window.SpeechRecognition();
    rec.lang = 'ru-RU';
    rec.interimResults = false;
    rec.continuous = true; // try to keep it listening
    rec.maxAlternatives = 1;

    rec.onresult = (evt) => {
      if(!evt.results) return;
      const text = evt.results[evt.results.length-1][0].transcript;
      handleCommand(text);
    };
    rec.onerror = (e) => {
      log('Recognition error: ' + e.error);
      // if not allowed or other error
      if(e.error === 'not-allowed' || e.error === 'service-not-allowed'){
        speak('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.');
        stopRecognition();
      }
    };
    rec.onend = () => {
      // –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫, –µ—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ "—Å–ª—É—à–∞—Ç—å"
      if(listening){
        try{ rec.start(); } catch(e){ log('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: '+e); }
      }
    };
    return rec;
  }

  function startRecognition(){
    if(listening) return;
    recognition = createRecognition();
    if(!recognition) return;
    try{
      recognition.start(); // –ø–µ—Ä–≤—ã–π —Å—Ç–∞—Ä—Ç –ø–æ—Ç—Ä–µ–±—É–µ—Ç –∫–ª–∏–∫/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
      listening = true;
      setStatus('–ê–∫—Ç–∏–≤–µ–Ω');
      startBtn.disabled = true;
      stopBtn.disabled = false;
      setCore('LISTEN');
      log('Jarvis –∑–∞–ø—É—â–µ–Ω. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ (–ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞).');
      speak('Jarvis –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –Ø —Å–ª—É—à–∞—é.');
    }catch(e){
      log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: ' + e);
    }
  }

  function stopRecognition(){
    if(!listening) return;
    try{
      recognition.stop();
      recognition = null;
    }catch(e){ }
    listening = false;
    setStatus('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    startBtn.disabled = false;
    stopBtn.disabled = true;
    setCore('OFF');
    speak('–í—ã–∫–ª—é—á–∞—é –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ.');
    log('Jarvis –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
  }

  // button handlers
  startBtn.addEventListener('click', async () => {
    // user gesture ‚Äî allowed to start microphone
    // we will request microphone via SpeechRecognition.start(); browser will prompt if needed
    startRecognition();
  });
  stopBtn.addEventListener('click', () => stopRecognition());

  // keyboard quickstart: Alt+J to toggle
  document.addEventListener('keydown', e => {
    if(e.altKey && (e.key === 'j' || e.key === 'J')) {
      if(listening) stopRecognition(); else startRecognition();
    }
  });

  // initial log
  log('–ì–æ—Ç–æ–≤. –ù–∞–∂–º–∏ "–ó–∞–ø—É—Å—Ç–∏—Ç—å Jarvis" –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ.');
  setStatus('–û–∂–∏–¥–∞–Ω–∏–µ');

  // expose for console tinkering
  window.jarvis = {
    speak, startRecognition, stopRecognition, handleCommand, memoryCommands
  };

  // extras: try to show PWA install prompt if available
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    log('PWA –≥–æ—Ç–æ–≤ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ. –ù–∞–∂–º–∏ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ ‚Üí –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
  });

})();
</script>
</body>
</html>
